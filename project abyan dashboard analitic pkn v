<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analitik PKN V - BPK RI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --earth-dark: #1e1b18;
            --earth-clay: #3d342d;
            --gold-primary: #d97706;
            --gold-light: #fbbf24;
            --bg-main: #fcfcfb;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--earth-dark);
            letter-spacing: -0.01em;
        }

        .sidebar-gradient {
            background: linear-gradient(195deg, #2d241e 0%, #1a1612 100%);
        }

        .glass-card { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.02), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.04);
        }

        .active-nav {
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.1) 0%, rgba(251, 191, 36, 0) 100%);
            color: var(--gold-light) !important;
        }

        .btn-premium {
            background: var(--earth-dark);
            transition: all 0.3s ease;
        }

        .btn-premium:hover {
            background: var(--gold-primary);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(217, 119, 6, 0.3);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        th { background-color: #f8fafc; }
        tr { transition: all 0.2s ease; }
    </style>
</head>
<body>

    <div class="flex min-h-screen">
        <aside class="w-72 sidebar-gradient text-stone-200 hidden md:flex flex-col p-8 fixed h-full z-20 shadow-2xl">
            <div class="mb-12">
                <div class="flex flex-col items-start gap-5">
                    <div class="p-3 bg-white rounded-2xl shadow-xl">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d2/BPK_insignia.svg/330px-BPK_insignia.svg.png" alt="Logo BPK" class="w-14 h-auto">
                    </div>
                    <div>
                        <h1 class="text-sm font-extrabold tracking-tight leading-tight text-white uppercase">
                            Badan Pemeriksa<br><span class="text-amber-400">Keuangan RI</span>
                        </h1>
                        <div class="mt-2 inline-block px-2 py-1 bg-white/10 rounded text-[9px] font-bold tracking-widest text-stone-400 uppercase">PKN V</div>
                    </div>
                </div>
            </div>
            
            <nav class="space-y-2 flex-1">
                <a href="#" class="active-nav flex items-center gap-4 p-3.5 rounded-xl text-sm font-bold transition-all">
                    <i class="fas fa-chart-pie w-5 text-amber-500"></i> Dashboard
                </a>
            </nav>

            <div class="mt-auto pt-6 border-t border-white/10">
                <div class="flex items-center gap-4 p-3 bg-black/20 rounded-2xl">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center font-black text-white text-xs shadow-lg">PKN V</div>
                    <div class="text-[11px]">
                        <p class="font-extrabold text-white">Sistem Analitik</p>
                        <span class="text-stone-500 font-medium tracking-tighter">v2.1.0-Stable</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 md:ml-72 p-6 lg:p-10">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="relative flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                        </span>
                        <span class="text-[10px] font-black text-emerald-600 uppercase tracking-[0.2em]">Real-time Database Active</span>
                    </div>
                    <h2 class="text-3xl lg:text-4xl font-extrabold text-[#2d241e] tracking-tight">Dashboard Analitik</h2>
                    <p class="text-stone-500 text-sm font-medium mt-1">Monitoring Pemeriksaan Keuangan Negara Wilayah V</p>
                </div>
                
                <div class="flex items-center gap-3">
                    <button id="clearDataBtn" class="bg-white border border-stone-200 px-5 py-3 rounded-2xl text-stone-500 text-xs font-bold hover:bg-red-50 hover:text-red-600 hover:border-red-100 transition-all flex items-center gap-2">
                        <i class="fas fa-trash-alt"></i> Bersihkan
                    </button>
                    <button id="importBtn" onclick="document.getElementById('uploadExcel').click()" class="btn-premium px-6 py-3 rounded-2xl text-white text-xs font-bold flex items-center gap-3 shadow-lg">
                        <i class="fas fa-file-excel text-amber-400"></i> Import Excel
                    </button>
                    <input type="file" id="uploadExcel" class="hidden" accept=".xlsx, .xls">
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-10">
                <div class="md:col-span-3 glass-card p-7 rounded-[2rem] bg-gradient-to-br from-white to-stone-50/50">
                    <p class="text-[10px] font-black text-stone-400 uppercase tracking-widest mb-1">Jumlah Satker</p>
                    <h3 id="dataCount" class="text-4xl font-extrabold text-stone-800">0</h3>
                </div>
                
                <div class="md:col-span-6 glass-card p-7 rounded-[2rem]">
                    <p class="text-[10px] font-black text-stone-400 uppercase tracking-widest mb-1"> Total Nilai Debet Satker</p>
                    <h3 id="totalDebetText" class="text-3xl font-black text-stone-800 break-all leading-tight">Rp0</h3>
                </div>

                <div class="md:col-span-3 glass-card p-7 rounded-[2rem] flex flex-col justify-center">
                    <p class="text-[10px] font-black text-stone-400 uppercase tracking-widest mb-1 text-center">Cloud Sync</p>
                    <div class="flex items-center justify-center gap-2">
                        <i class="fas fa-check-circle text-emerald-500"></i>
                        <h3 class="text-lg font-bold text-emerald-600">Terhubung</h3>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
                <div class="lg:col-span-8 glass-card p-8 rounded-[2.5rem]">
                    <div class="flex items-center justify-between mb-8">
                        <h4 class="font-extrabold text-stone-700 flex items-center gap-3 text-sm">
                            <span class="w-1.5 h-5 bg-amber-500 rounded-full"></span>
                            Visualisasi Anggaran Per Satker
                        </h4>
                    </div>
                    <div class="h-[380px]"><canvas id="barExcel"></canvas></div>
                </div>

                <div class="lg:col-span-4 glass-card p-8 rounded-[2.5rem]">
                    <h4 class="font-extrabold text-stone-700 mb-8 text-center uppercase text-[11px] tracking-widest">Sumber Dana</h4>
                    <div class="h-[380px]"><canvas id="pieExcel"></canvas></div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-10">
                <div class="glass-card rounded-[2.5rem] overflow-hidden">
                    <div class="px-8 py-6 border-b border-stone-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-white/80">
                        <h4 class="font-extrabold text-stone-800 flex items-center gap-3">
                            <i class="fas fa-university text-amber-500"></i> Akumulasi Per Satker
                        </h4>
                        <div class="relative w-full md:w-80">
                            <input type="text" id="searchInput" placeholder="Cari satuan kerja..." class="w-full pl-10 pr-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl text-sm focus:ring-4 focus:ring-amber-500/10 focus:border-amber-500 transition-all outline-none">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 text-xs"></i>
                        </div>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar max-h-[450px]">
                        <table class="w-full text-left border-separate border-spacing-0">
                            <thead class="sticky top-0 z-10 shadow-sm">
                                <tr class="text-[10px] uppercase tracking-widest text-stone-500 font-bold">
                                    <th class="px-8 py-4 border-b border-stone-100">Nama Satuan Kerja</th>
                                    <th class="px-8 py-4 border-b border-stone-100 text-right">Nominal Debet</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="text-[13px] text-stone-600"></tbody>
                        </table>
                    </div>
                </div>

                <div class="glass-card rounded-[2.5rem] overflow-hidden">
                    <div class="px-8 py-6 border-b border-stone-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-white/80">
                        <h4 class="font-extrabold text-stone-800 flex items-center gap-3">
                            <i class="fas fa-file-invoice-dollar text-amber-500"></i> Akumulasi Per Nama Akun
                        </h4>
                        <div class="relative w-full md:w-80">
                            <input type="text" id="searchAccountInput" placeholder="Cari nama akun..." class="w-full pl-10 pr-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl text-sm focus:ring-4 focus:ring-amber-500/10 focus:border-amber-500 transition-all outline-none">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 text-xs"></i>
                        </div>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar max-h-[450px]">
                        <table class="w-full text-left border-separate border-spacing-0">
                            <thead class="sticky top-0 z-10 shadow-sm">
                                <tr class="text-[10px] uppercase tracking-widest text-stone-500 font-bold">
                                    <th class="px-8 py-4 border-b border-stone-100">Nama Akun</th>
                                    <th class="px-8 py-4 border-b border-stone-100 text-right">Nominal Debet</th>
                                </tr>
                            </thead>
                            <tbody id="accountTableBody" class="text-[13px] text-stone-600"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="progressContainer" class="hidden fixed bottom-8 right-8 w-72 bg-white/95 backdrop-blur-md p-5 rounded-3xl shadow-2xl border border-stone-100 z-50">
        <div class="flex flex-col gap-3">
            <div class="flex justify-between items-center">
                <p id="progressTitle" class="text-[10px] font-black uppercase text-amber-600 tracking-widest">Syncing</p>
                <span id="progressPercent" class="text-xs font-black text-stone-800">0%</span>
            </div>
            <div class="w-full bg-stone-100 rounded-full h-1.5 overflow-hidden">
                <div id="progressBar" class="bg-amber-500 h-full transition-all duration-300 shadow-[0_0_10px_rgba(245,158,11,0.5)]" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, writeBatch, doc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-ullLsdGK20KTiBziR9EqAAPYdhRJcYw",
            authDomain: "bpk-analytics-v2.firebaseapp.com",
            projectId: "bpk-analytics-v2",
            storageBucket: "bpk-analytics-v2.firebasestorage.app",
            messagingSenderId: "395073856763",
            appId: "1:395073856763:web:c90fac4530978e21dc7c5e",
            measurementId: "G-HY42SEWNVV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let charts = {};
        let rawDataFromFirebase = [];

        const formatIDR = (v) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(v);

        const setProgress = (percent, title = "Syncing") => {
            const el = document.getElementById('progressContainer');
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').innerText = `${Math.round(percent)}%`;
            document.getElementById('progressTitle').innerText = title;
            el.classList.toggle('hidden', percent <= 0);
            if (percent >= 100) {
                setTimeout(() => el.classList.add('hidden'), 1500);
            }
        };

        // --- BERSIHKAN DATABASE ---
        document.getElementById('clearDataBtn').addEventListener('click', async () => {
            if(!confirm("Anda yakin ingin menghapus seluruh database? Tindakan ini tidak dapat dibatalkan.")) return;
            try {
                setProgress(5, "Membaca Database...");
                const snap = await getDocs(collection(db, "transaksi_audit"));
                if(snap.empty) { alert("Database sudah kosong."); setProgress(0); return; }

                const docs = snap.docs;
                const total = docs.length;
                const CHUNK = 450;
                for (let i = 0; i < total; i += CHUNK) {
                    const batch = writeBatch(db);
                    docs.slice(i, i + CHUNK).forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    setProgress(((i + CHUNK) / total) * 100, `Menghapus...`);
                }
            } catch (e) { alert("Error: " + e.message); }
            finally { setProgress(100); setTimeout(()=>setProgress(0),1000); }
        });

        // --- IMPOR EXCEL (DIPERBAIKI UNTUK MULTI-SHEET) ---
        document.getElementById('uploadExcel').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const dataArray = new Uint8Array(ev.target.result);
                const wb = XLSX.read(dataArray, { type: 'array' });
                
                let allCombinedRows = [];

                // 1. Ambil data dari semua sheet yang ada di file
                wb.SheetNames.forEach(sheetName => {
                    const sheet = wb.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    allCombinedRows = allCombinedRows.concat(json);
                });

                if(allCombinedRows.length === 0) {
                    alert("File kosong atau tidak terbaca.");
                    return;
                }

                if(!confirm(`Terdeteksi ${allCombinedRows.length} baris data dari ${wb.SheetNames.length} sheet. Import ke cloud?`)) return;

                try {
                    const CHUNK = 300;
                    for (let i = 0; i < allCombinedRows.length; i += CHUNK) {
                        const batch = writeBatch(db);
                        allCombinedRows.slice(i, i + CHUNK).forEach(row => {
                            const newDoc = doc(collection(db, "transaksi_audit"));
                            
                            // Deteksi kolom lebih fleksibel
                            const namaSatker = row.NAMA_SATKER || row['NAMA SATKER'] || row['Nama Satker'] || "";
                            const namaAkun = row.NAMA_AKUN || row['NAMA AKUN'] || row['Nama Akun'] || row.URAIAN_AKUN || "";
                            const nominal = row.DEBET || row.Debet || row['DEBET '] || 0;
                            const sumber = row.NAMA_SUMBER_DANA || row['NAMA SUMBER DANA'] || row['Nama Sumber Dana'] || "RM";

                            batch.set(newDoc, {
                                satker: namaSatker.toString().toUpperCase().trim(),
                                akun: namaAkun.toString().toUpperCase().trim(),
                                debet: Number(nominal),
                                sumber: sumber.toString(),
                                ts: new Date()
                            });
                        });
                        await batch.commit();
                        setProgress(((i + CHUNK) / allCombinedRows.length) * 100, "Mengunggah Data...");
                    }
                } catch (err) { 
                    console.error(err);
                    alert("Gagal mengunggah: " + err.message); 
                }
                setProgress(100);
                e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        });

        // --- REALTIME LISTENER ---
        onSnapshot(query(collection(db, "transaksi_audit"), orderBy("ts", "desc")), (snap) => {
            rawDataFromFirebase = [];
            snap.forEach(doc => rawDataFromFirebase.push(doc.data()));
            renderUI(rawDataFromFirebase);
        });

        // --- RENDER UI ---
        function renderUI(data) {
            const searchVal = document.getElementById('searchInput').value.toUpperCase();
            const searchAccVal = document.getElementById('searchAccountInput').value.toUpperCase();

            // 1. Pisahkan Data
            const dataSatkerHanya = data.filter(item => item.satker !== "" && item.satker !== "N/A");
            const dataAkunHanya = data.filter(item => item.akun !== "" && item.akun !== "N/A");

            // 2. Akumulasi Satker
            const filteredRawBySatker = dataSatkerHanya.filter(item => item.satker.includes(searchVal));
            const groupedSatker = filteredRawBySatker.reduce((acc, curr) => {
                const key = curr.satker;
                if (!acc[key]) acc[key] = { satker: key, totalDebet: 0 };
                acc[key].totalDebet += curr.debet;
                return acc;
            }, {});
            const satkerArray = Object.values(groupedSatker).sort((a, b) => b.totalDebet - a.totalDebet);

            // 3. Akumulasi Akun
            const groupedAccount = dataAkunHanya.reduce((acc, curr) => {
                const key = curr.akun;
                if (!acc[key]) acc[key] = { namaAkun: key, totalDebet: 0 };
                acc[key].totalDebet += curr.debet;
                return acc;
            }, {});
            const accountArray = Object.values(groupedAccount)
                .filter(item => item.namaAkun.includes(searchAccVal))
                .sort((a, b) => b.totalDebet - a.totalDebet);

            // 4. Update Header
            const totalKeseluruhanSatker = dataSatkerHanya.reduce((sum, item) => sum + item.debet, 0);
            document.getElementById('dataCount').innerText = satkerArray.length.toLocaleString('id-ID');
            document.getElementById('totalDebetText').innerText = formatIDR(totalKeseluruhanSatker);

            // 5. Render Tabel Satker
            document.getElementById('tableBody').innerHTML = satkerArray.map(item => `
                <tr class="hover:bg-amber-50/50 border-b border-stone-50">
                    <td class="px-8 py-4 font-semibold text-stone-700 leading-snug">${item.satker}</td>
                    <td class="px-8 py-4 text-right font-mono font-bold text-amber-700">${formatIDR(item.totalDebet)}</td>
                </tr>
            `).join('') || '<tr><td colspan="2" class="p-20 text-center text-stone-400">Data satker tidak ditemukan.</td></tr>';

            // 6. Render Tabel Akun
            document.getElementById('accountTableBody').innerHTML = accountArray.map(item => `
                <tr class="hover:bg-amber-50/50 border-b border-stone-50">
                    <td class="px-8 py-4 font-semibold text-stone-700 leading-snug">${item.namaAkun}</td>
                    <td class="px-8 py-4 text-right font-mono font-bold text-amber-700">${formatIDR(item.totalDebet)}</td>
                </tr>
            `).join('') || '<tr><td colspan="2" class="p-20 text-center text-stone-400">Data akun tidak ditemukan.</td></tr>';
            
            updateCharts(satkerArray, filteredRawBySatker);
        }

        // --- SEARCH EVENT ---
        document.getElementById('searchInput').addEventListener('input', () => renderUI(rawDataFromFirebase));
        document.getElementById('searchAccountInput').addEventListener('input', () => renderUI(rawDataFromFirebase));

        // --- CHARTS LOGIC ---
        function updateCharts(groupedData, raw) {
            const searchVal = document.getElementById('searchInput').value;
            const chartData = searchVal.trim() === "" ? groupedData.slice(0, 10) : groupedData;

            if(charts.bar) charts.bar.destroy();
            charts.bar = new Chart(document.getElementById('barExcel'), {
                type: 'bar',
                data: {
                    labels: chartData.map(i => i.satker), 
                    datasets: [{ 
                        label: 'Total Akumulasi',
                        data: chartData.map(i => i.totalDebet), 
                        backgroundColor: '#d97706',
                        borderRadius: 12,
                        barThickness: 25
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { padding: 12, callbacks: { label: (ctx) => ' ' + formatIDR(ctx.raw) } } },
                    scales: { 
                        y: { border: { display: false }, grid: { color: '#f1f1f1' }, ticks: { font: { size: 10 }, callback: v => 'Rp' + (v/1e9).toFixed(1) + 'M' } },
                        x: { border: { display: false }, grid: { display: false }, ticks: { font: { size: 9 }, callback: function(v) { 
                            const lbl = this.getLabelForValue(v);
                            return lbl.length > 15 ? lbl.substring(0, 12) + '..' : lbl;
                        }}}
                    }
                }
            });

            const sourceCounts = raw.reduce((acc, curr) => {
                if(curr.debet > 0) acc[curr.sumber] = (acc[curr.sumber] || 0) + 1;
                return acc;
            }, {});

            if(charts.pie) charts.pie.destroy();
            charts.pie = new Chart(document.getElementById('pieExcel'), {
                type: 'pie',
                data: {
                    labels: Object.keys(sourceCounts),
                    datasets: [{ 
                        data: Object.values(sourceCounts), 
                        backgroundColor: ['#00abd2', '#ff9f00', '#418cf0', '#8bc300', '#757e83'],
                        borderWidth: 0 
                    }]
                },
                plugins: [ChartDataLabels],
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                        datalabels: {
                            color: '#fff', 
                            font: { weight: 'bold', size: 12 },
                            textAlign: 'center',
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                                let percentage = (value * 100 / sum).toFixed(0);
                                return percentage > 3 ? percentage + "%" : ""; 
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
